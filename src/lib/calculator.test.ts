import { describe, it, expect } from 'vitest';
import { calculateFinancials } from './calculator';
import { AccountRow } from './calculationTypes';

describe('calculateFinancials', () => {
  describe('Income (Приходи) calculations', () => {
    it('should sum credit turnover for accounts 701-709', () => {
      const data: AccountRow[] = [
        { номер: 701, име: 'Приходи от продажби', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 1000, крайно_салдо_дебит: 0, крайно_салдо_кредит: 1000 },
        { номер: 702, име: 'Приходи от услуги', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 2000, крайно_салдо_дебит: 0, крайно_салдо_кредит: 2000 },
        { номер: 709, име: 'Други приходи', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 500, крайно_салдо_дебит: 0, крайно_салдо_кредит: 500 },
      ];

      const result = calculateFinancials(data);

      expect(result.приходи).toBe(3500);
      expect(result.details.приходи).toHaveLength(3);
    });

    it('should sum credit turnover for accounts 721-729', () => {
      const data: AccountRow[] = [
        { номер: 721, име: 'Финансови приходи', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 1500, крайно_салдо_дебит: 0, крайно_салдо_кредит: 1500 },
        { номер: 725, име: 'Приходи от лихви', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 250, крайно_салдо_дебит: 0, крайно_салдо_кредит: 250 },
      ];

      const result = calculateFinancials(data);

      expect(result.приходи).toBe(1750);
      expect(result.details.приходи).toHaveLength(2);
    });

    it('should not include accounts outside 701-709 and 721-729 ranges', () => {
      const data: AccountRow[] = [
        { номер: 700, име: 'Account 700', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 9999, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 710, име: 'Account 710', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 9999, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 720, име: 'Account 720', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 9999, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 730, име: 'Account 730', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 9999, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.приходи).toBe(0);
      expect(result.details.приходи).toHaveLength(0);
    });

    it('should not include accounts with zero credit turnover in details', () => {
      const data: AccountRow[] = [
        { номер: 701, име: 'Приходи', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 100, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.приходи).toBe(0);
      expect(result.details.приходи).toHaveLength(0);
    });
  });

  describe('Expenses (Разходи) calculations', () => {
    it('should sum debit turnover for accounts 601-609', () => {
      const data: AccountRow[] = [
        { номер: 601, име: 'Разходи за материали', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 5000, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 602, име: 'Разходи за заплати', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 10000, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 609, име: 'Други разходи', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 1500, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.разходи).toBe(16500);
      expect(result.details.разходи).toHaveLength(3);
    });

    it('should sum debit turnover for accounts 621-629', () => {
      const data: AccountRow[] = [
        { номер: 621, име: 'Финансови разходи', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 750, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 625, име: 'Разходи за лихви', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 300, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.разходи).toBe(1050);
      expect(result.details.разходи).toHaveLength(2);
    });

    it('should include specific accounts 302 and 304', () => {
      const data: AccountRow[] = [
        { номер: 302, име: 'Материали', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 2000, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 304, име: 'Стоки', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 3000, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.разходи).toBe(5000);
      expect(result.details.разходи).toHaveLength(2);
    });

    it('should not include account 303 (only 302 and 304 are specific expense accounts)', () => {
      const data: AccountRow[] = [
        { номер: 303, име: 'Account 303', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 9999, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.разходи).toBe(0);
    });
  });

  describe('Other Receivables (Др. вземания) calculations', () => {
    it('should sum final debit balance for specific account numbers', () => {
      const data: AccountRow[] = [
        { номер: 493, име: 'Разчети със собственици', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 5000, крайно_салдо_кредит: 0 },
        { номер: 498, име: 'Други дебитори', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 3000, крайно_салдо_кредит: 0 },
        { номер: 499, име: 'Други вземания', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 2000, крайно_салдо_кредит: 0 },
        { номер: 262, име: 'Account 262', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 1000, крайно_салдо_кредит: 0 },
        { номер: 265, име: 'Account 265', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 500, крайно_салдо_кредит: 0 },
        { номер: 422, име: 'Account 422', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 1500, крайно_салдо_кредит: 0 },
        { номер: 159, име: 'Account 159', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 750, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.др_вземания).toBe(13750);
      expect(result.details.др_вземания).toHaveLength(7);
    });

    it('should not include accounts not in the specific list', () => {
      const data: AccountRow[] = [
        { номер: 494, име: 'Not a receivable account', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 9999, крайно_салдо_кредит: 0 },
        { номер: 261, име: 'Not a receivable account', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 9999, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.др_вземания).toBe(0);
    });
  });

  describe('Other Liabilities (Др. задължения) calculations', () => {
    it('should sum final credit balance for accounts 490-499', () => {
      const data: AccountRow[] = [
        { номер: 490, име: 'Задължения', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 10000 },
        { номер: 495, име: 'Други задължения', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 5000 },
      ];

      const result = calculateFinancials(data);

      expect(result.др_задължения).toBe(15000);
      expect(result.details.др_задължения).toHaveLength(2);
    });

    it('should sum final credit balance for accounts 420-429', () => {
      const data: AccountRow[] = [
        { номер: 420, име: 'Доставчици', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 8000 },
        { номер: 429, име: 'Други кредитори', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 2000 },
      ];

      const result = calculateFinancials(data);

      expect(result.др_задължения).toBe(10000);
    });

    it('should include specific account 159', () => {
      const data: AccountRow[] = [
        { номер: 159, име: 'Account 159', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 4000 },
      ];

      const result = calculateFinancials(data);

      expect(result.др_задължения).toBe(4000);
    });
  });

  describe('Cash (Каса) calculations', () => {
    it('should calculate cash as debit minus credit for account 501 (BGN)', () => {
      const data: AccountRow[] = [
        { номер: 501, име: 'Каса в лева', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 5000, крайно_салдо_кредит: 1000 },
      ];

      const result = calculateFinancials(data);

      expect(result.каса).toBe(4000); // 5000 - 1000
      expect(result.details.каса).toHaveLength(1);
      expect(result.details.каса[0].стойност).toBe(4000);
    });

    it('should calculate cash as debit minus credit for account 502 (EUR)', () => {
      const data: AccountRow[] = [
        { номер: 502, име: 'Каса в евро', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 3000, крайно_салдо_кредит: 500 },
      ];

      const result = calculateFinancials(data);

      expect(result.каса).toBe(2500); // 3000 - 500
    });

    it('should sum cash from both 501 and 502 accounts', () => {
      const data: AccountRow[] = [
        { номер: 501, име: 'Каса в лева', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 5000, крайно_салдо_кредит: 1000 },
        { номер: 502, име: 'Каса в евро', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 3000, крайно_салдо_кредит: 500 },
      ];

      const result = calculateFinancials(data);

      expect(result.каса).toBe(6500); // (5000-1000) + (3000-500)
      expect(result.details.каса).toHaveLength(2);
    });

    it('should handle negative cash balance (more credit than debit)', () => {
      const data: AccountRow[] = [
        { номер: 501, име: 'Каса в лева', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 1000, крайно_салдо_кредит: 3000 },
      ];

      const result = calculateFinancials(data);

      expect(result.каса).toBe(-2000); // 1000 - 3000
    });

    it('should not include zero cash values in details', () => {
      const data: AccountRow[] = [
        { номер: 501, име: 'Каса в лева', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 1000, крайно_салдо_кредит: 1000 },
      ];

      const result = calculateFinancials(data);

      expect(result.каса).toBe(0);
      expect(result.details.каса).toHaveLength(0);
    });

    it('should not include account 503 in cash calculations', () => {
      const data: AccountRow[] = [
        { номер: 503, име: 'Account 503', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 9999, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.каса).toBe(0);
    });
  });

  describe('Combined calculations', () => {
    it('should handle empty data array', () => {
      const result = calculateFinancials([]);

      expect(result.приходи).toBe(0);
      expect(result.разходи).toBe(0);
      expect(result.др_вземания).toBe(0);
      expect(result.др_задължения).toBe(0);
      expect(result.каса).toBe(0);
    });

    it('should correctly categorize accounts into multiple categories when applicable', () => {
      // Account 159 appears in both вземания and задължения lists
      // Account 493 appears in both вземания numbers list and within задължения range (490-499)
      const data: AccountRow[] = [
        { номер: 159, име: 'Account 159', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 1000, крайно_салдо_кредит: 500 },
        { номер: 493, име: 'Account 493', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 2000, крайно_салдо_кредит: 800 },
      ];

      const result = calculateFinancials(data);

      // 159 should be in both receivables (debit) and liabilities (credit)
      expect(result.др_вземания).toBe(3000); // 159 (1000) + 493 (2000)
      expect(result.др_задължения).toBe(1300); // 159 (500) + 493 (800)
    });

    it('should process a comprehensive dataset correctly', () => {
      const data: AccountRow[] = [
        // Income accounts
        { номер: 701, име: 'Приходи от продажби', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 50000, крайно_салдо_дебит: 0, крайно_салдо_кредит: 50000 },
        { номер: 721, име: 'Финансови приходи', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 1000, крайно_салдо_дебит: 0, крайно_салдо_кредит: 1000 },
        // Expense accounts
        { номер: 601, име: 'Разходи за материали', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 20000, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 621, име: 'Финансови разходи', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 500, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 302, име: 'Материали', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 5000, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        // Receivables
        { номер: 493, име: 'Вземания', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 3000, крайно_салдо_кредит: 0 },
        // Liabilities
        { номер: 420, име: 'Доставчици', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 0, крайно_салдо_кредит: 10000 },
        // Cash
        { номер: 501, име: 'Каса в лева', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0, крайно_салдо_дебит: 15000, крайно_салдо_кредит: 2000 },
      ];

      const result = calculateFinancials(data);

      expect(result.приходи).toBe(51000); // 50000 + 1000
      expect(result.разходи).toBe(25500); // 20000 + 500 + 5000
      expect(result.др_вземания).toBe(3000);
      expect(result.др_задължения).toBe(10000);
      expect(result.каса).toBe(13000); // 15000 - 2000
    });

    it('should handle decimal precision correctly', () => {
      const data: AccountRow[] = [
        { номер: 701, име: 'Приходи', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 1234.56, крайно_салдо_дебит: 0, крайно_салдо_кредит: 1234.56 },
        { номер: 702, име: 'Приходи 2', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 0.01, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0.01 },
      ];

      const result = calculateFinancials(data);

      expect(result.приходи).toBeCloseTo(1234.57, 2);
    });
  });

  describe('Edge cases', () => {
    it('should handle very large numbers', () => {
      const data: AccountRow[] = [
        { номер: 701, име: 'Large income', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 999999999.99, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.приходи).toBe(999999999.99);
    });

    it('should handle account at exact boundary values', () => {
      const data: AccountRow[] = [
        // Exact boundaries for income ranges
        { номер: 701, име: 'Start of 701-709', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 100, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 709, име: 'End of 701-709', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 100, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 721, име: 'Start of 721-729', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 100, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
        { номер: 729, име: 'End of 721-729', начално_салдо_дебит: 0, начално_салдо_кредит: 0, оборот_дебит: 0, оборот_кредит: 100, крайно_салдо_дебит: 0, крайно_салдо_кредит: 0 },
      ];

      const result = calculateFinancials(data);

      expect(result.приходи).toBe(400);
    });
  });
});
